import os
from flask import Flask, request, jsonify
import telebot
from telebot import types
from PIL import Image, ImageDraw, ImageFont
import io
import logging

app = Flask(__name__)
TOKEN = os.getenv("TELEGRAM_TOKEN")
bot = telebot.TeleBot(TOKEN)

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (—Ü–≤–µ—Ç, —à—Ä–∏—Ñ—Ç)
user_data = {}

# –ü—É—Ç–∏ –∫ —Ñ–∞–π–ª–∞–º (–≤–∞–∂–Ω–æ –¥–ª—è Vercel)
TEMPLATES_DIR = os.path.join(os.path.dirname(__file__), 'templates')
FONTS_DIR = os.path.join(os.path.dirname(__file__), 'fonts')

# –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –≤—ã–±–æ—Ä–∞ —Ü–≤–µ—Ç–∞
def color_keyboard():
    markup = types.ReplyKeyboardMarkup(row_width=3)
    btn1 = types.KeyboardButton("‚ö™ –ë–µ–ª—ã–π")
    btn2 = types.KeyboardButton("‚ö´ –ß–µ—Ä–Ω—ã–π")
    btn3 = types.KeyboardButton("üî¥ –ö—Ä–∞—Å–Ω—ã–π")
    markup.add(btn1, btn2, btn3)
    return markup

# –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –≤—ã–±–æ—Ä–∞ —à—Ä–∏—Ñ—Ç–∞
def font_keyboard():
    markup = types.ReplyKeyboardMarkup(row_width=3)
    btn1 = types.KeyboardButton("Arial")
    btn2 = types.KeyboardButton("Comic Sans")
    btn3 = types.KeyboardButton("Times New Roman")
    markup.add(btn1, btn2, btn3)
    return markup

# –ö–æ–º–∞–Ω–¥–∞ /start
@bot.message_handler(commands=['start'])
def start(message):
    try:
        bot.send_message(
            message.chat.id,
            "üëï –ü—Ä–∏–≤–µ—Ç! –Ø —Å–æ–∑–¥–∞–º —Ñ—É—Ç–±–æ–ª–∫—É —Å —Ç–≤–æ–∏–º —Ç–µ–∫—Å—Ç–æ–º.\n"
            "‚û°Ô∏è –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ —Ü–≤–µ—Ç —Ñ—É—Ç–±–æ–ª–∫–∏:",
            reply_markup=color_keyboard()
        )
    except Exception as e:
        logger.error(f"Error in start: {e}")

# ... (–æ—Å—Ç–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Å—Ç–∞—é—Ç—Å—è –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–º–∏, –Ω–æ —Å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º try-except)

# –í–µ–±—Ö—É–∫ –¥–ª—è Vercel
@app.route('/', methods=['GET'])
def home():
    return "–ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç!", 200

@app.route('/webhook', methods=['POST'])
def webhook():
    if request.headers.get('content-type') == 'application/json':
        json_data = request.stream.read().decode('utf-8')
        logger.info(f"Received update: {json_data}")
        try:
            update = telebot.types.Update.de_json(json_data)
            bot.process_new_updates([update])
            return 'OK', 200
        except Exception as e:
            logger.error(f"Error processing update: {e}")
            return 'Error', 500
    return 'Unsupported Media Type', 415

# –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
if __name__ == '__main__':
    app.run(debug=True)
